date：2024-04-12

# 0 过程记录

智能充电模式
功能需求点：
1、灭屏状态：用户睡眠时段充电至80时，停充；用户在即将使用手机前，将电量充满

2、持续充电24h+电量为100，停充，掉电至60时再充满（如此循环）

3、长时间处于高温
条件：**7天内**温度高于**45度**的时间累计总长≥**50h**
操作：充到**80**停充并通知栏提醒
复充：用户点击“恢复充电” or 7天内温度高于45的累计时间＜50h

需要数据：电池不同时间点对应的温度（如何时间点数据计算高温时长？）

4、长时间处于充电状态
条件：**7天**内充电累计时长≥**100h**
操作：充到80停充并通知栏提醒
复充：用户点击“恢复充电” or 7天内充电累计时长＜100h

需要数据：当前时间下的充电累计时长


问题：
用户点击“恢复充电”后，是否重新计算累计高温、充电时长和持续充电时长？
如果重新计算：

1充电情况下开机，数据如何计算
2直接断电关机情况，数据如何处理

重点问题：
数据的获取
逻辑的实现（保证服务的持续稳定且不增加过多功耗）

# TODO
1 √ 点击“恢复充电”时，需要传递哪个数据超过了阈值，以清除对应的数据，目前处理是全清数据

2 √ 当高温和充电时间都满足条件发出通知时，该如何处理？（要求是发出一条通知还是两条通知？）
	先高温后充电时长，只会出现一条通知

3 √ 充着电开机时，power是否能接收到充电广播，记录开始充电时间（目前单独在demo中不行，因为powerReceiver是动态注册的，需实验当其集成到SystemUI中时，是否能接收到）
	在SystemUI中也接收不到开机广播（动态注册的情况下），所以需要静态注册PowerReceiver

4 √ 如果在充到80以后满足了高温或者累计时长条件，是否需要停充？
	直接停充

5 √ 充电时，当电量达到80后，开始就要检测是否满足高温和时长两个条件，当满足时，随时停止充电，直到不满足对应条件

6 √ 底层要能获取到当前是否插有有效充电器（停充后如果满足复充条件，则复充）。如果没有的话，就要时刻检测是否满足复充条件
	可检测是否通过usb或ac充电（即使在停充情况下）

7 持续充电24h时，用户点击恢复充电，需要清除哪部分数据？（这一次的充电数据？所有充电时间记录数据？不清空数据，只是复充？（不行，不清空此次充电时间数据，马上又会满足条件））
	所以最后结果：清除单次数据/所有充电时间数据/重新记录开始充电，之前数据不变

8 √ 断开电源后，停充提示的通知栏通知需撤销
	如果没有充电器插着的状态下，会撤销3条通知。

9 √ 调用停充节点后，停充状态可以一直保持到什么时候（关机？恢复出厂设置？断电？）
	理想状态：停充后，若断电，则停充失效，若一直插电，则需调用复充节点才能继续充电。
	实际状态：不手动恢复或者恢复出厂，该值会一直有效，所以在停充后，一定要特别注意何时复充（）
	在停充后，因为一直处于接收广播的状态，所以只要条件失效，那么就会复充。

停充时关机插电重启：

10 √ 部分情况下会读取数据卡顿（点击“计算充电时长”无反应），此时通知音（Temperature.java）一直响
	去除部分打印log及判断通知栏中是否存在已有通知
	
11 √ BatteryLeverReceiver中对各个条件进行判断，需充分考虑清楚是否充电和是否插电两种情况之间的差异判断
	只有24h的情况下必须在正在充电的状态下进行判断，其余高温和充电时长两个情况需要在插电（可不充电）状态下判断

12 √在calculate累计时长数据时，会筛选7天内的数据，但此时只是将合格数据返回，并不会更改内存中存储的preference，是否需要同步更改？
	保存数据时的timeList是直接传入的，而这个list是通过load获得的，故无需再次处理数据是否在范围内
	且在计算累计时长时，会再次判断数据是否在7天内
	
13 在计算累计时长时，如何保证记录的时间戳是一对一对的？（充电和高温数据）


14 当由于24h停充后，batteryLeverReceiver接收到电量变化，重新判断，会立马复充，导致因为24h停充意外中断，且通知栏通知依旧存在
判断条件顺序为123，如果2判断停充后，重新判断，不满足1的情况下，会导致异常复充（因为不满足1复充，但其实当前是满足2停充的，故存在矛盾）
	在停充时，每次都按照123的顺序停充
	在复充时，需要验证后续的条件是否满足，均不满足方可复充

15 √如果一直openCharge，电池就会一直发出batteryChange广播，导致疯狂打log
	只有在当前插着充电器+未在充电的情况，才openCharge
	
16 如果电量低于60，且满足高温或充电时长情况，是否继续停充？

17 √ 直接断电情况下的处理
	在向timeList中add结束时间戳时，判断timeList中最后一个时间戳是否为开始时间，如果不是（为负数），则不add此次时间戳
	同时能避免出现timeList中只记录有结束时间戳而没有对应的开始时间

18 充电优先级要保证
	当三个标志位全部为false的情况下，需要复充，避免某些意料之外的停充导致机器无法充电
	标志位为false时，需要同步检测通知栏是否有对应通知？

19 编入SystemUI后，在开机动画时插入电源，会导致机器有两次插入电源时间记录（第一次是电池状态变化，第二次是开机完成广播接收到时，检查处于充电状态），进而导致无法正常记录开机完成前就插入电源情况的充电时长记录。
	当前机器在插电重启时，有开机后不显示充电的bug，该bug影响上述问题的修改。

20 已知当前先停充，再打开完全停充，会出问题，
	是否存在这种情况，先停充了，又关闭了完全停充，是否会出问题？
	先开启完全停充，再关闭停充 -> 还是无法充电

如何恢复充电？？？

21 73以下电量不充电，此时enable_all=0，enable=1，
	因为是在enable_all=0的情况下（完全停充状态）断开的电，而再插电时，只是使enable=1，但enable_all的优先级更高，所以此时插上电线依旧无法充电。
	解决：不满足停充情况下，最后保证插电状态下能充电的openCharge改为openChargeAll
# 复充实现
当停充后，复充需要检测多个条件是否满足
0、用户点击“恢复充电”
1、高温累计时长
2、连续充电累计时长
3、连续24h条件（掉电到60%）

判断实现：
首先需要获取当前是否处于停充状态（由于浮充功能停充）以及停充原因  
然后根据停充原因，判断是否满足对应复充条件，来控制是否复充
设置全局变量：
	高温停充-flag1
	充电过长停充-flag2
	24过充停充-flag3
注意：在停充时设置flag，复充时恢复flag

复充时，是否需要判断当前是否处于插充电器但停充的状态？
	是否存在某种状态：插着充电器，但停充，且此刻由于停充条件被打破（高温和充电时长两个情况下），需要复充。

调用停充节点后，如果需要再次调用复充节点才能充电，那么需要特别处理复充节点调用逻辑，否则如果断电再插电即可复充，则无需单独处理复充？？？

√断开电源的影响：
	如果睡眠功能/24小时功能导致的停充，那么断开电源后，再接电源就需要恢复充电
	如果高温/充电时长功能导致的停充，断开电源后，再接电源，如果满足停充条件，依旧需要停充
		插电时，检查高温、充电时长的flag，如果为true且时长满足条件，则继续停充且通知栏提示（是否已有功能已可实现？）
	！断充通知应该要撤销
	经分析，每次插电后，必定会检查上述4个条件是否满足，默认是插上就开始充电，如果不满足对应条件，就会触发停充逻辑，故无需特别处理。



目前已实现：根据接收到的广播来读取、记录、保存数据，  
	目前已经实现的核心要点是：基于BroadReceiver实现，数据记录和保存及加载，均在接收到广播的时候执行


# 睡眠检测
需要注册移动检测服务，并在服务检测到移动后，BatteryLevelReceiver中的Util才能获取到对应的timeList（包括之前的数据）

flagFallSleep标记位设置问题：不移动设备不会改变

设备先解锁再移动，这种情况下的数据不会被记录

## 功耗问题
1、只在息屏时监听传感器，亮屏时关闭监听？
2、定时段监听？
3、插电状态才监听？


**功能特性2的场景**：电量在100%-80%区间需要关闭充电和power path，系统耗电和电池自耗电都由电池供电；电量低于80%需要打开power path，电量下降到75% 之后恢复充电至80% 停止。
满足24h且电量为100：完全停充
	电量掉到80：关闭完全停充，开启停充
	电量掉到75：恢复充电


------------------------------------------------------

主要操作：
1通知栏提醒已停充
2检测是否满足条件（获取并计算各类数值）

# 1 目标


# 2 实现


# 3 相关资料
[]()