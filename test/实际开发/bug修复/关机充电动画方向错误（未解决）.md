date：2023-11-24

# 1 现象

机器是物理竖屏，但是将其改为横屏，其他方向都正确，唯独充电动画方向错误，且画面有残缺。

**该问题最后未解决，转移给驱动了。但由于该问题花费时间较长，且接触到了不少新内容，故将其中过程记录**
# 2 原因


# 3 解决

## 定位错误出现的提交
首先确定哪个版本开始出现该问题，从服务器上刷不同版本的代码确定，找到最初产生该bug的版本。
## 单独定位初次产生bug版本中的具体提交
找到最初源版本后，可以单独revert该版本中相关的提交，然后编译刷机确定是否该提交是否有影响，进而缩小对该bug有贡献的提交范围。

经查，发现该bug涉及到的更改实际上就几个地方，主要就是屏幕旋转角度控制以及logo库。

首先可以排除logo库，因为发现其中和关机充电动画相关的资源文件都是相同的，只有充电logo不同。（其实也revert验证了这个修改。。。纯属浪费时间了有点）

然后涉及到的就是旋转角度的修改。因为该套代码做的是上层横屏，而驱动层是按照竖屏进行的，所以这个部分就比较复杂去验证，但主要分为两个方面：  
1、节点旋转值的控制  
```mk
PRODUCT_DEFAULT_PROPERTY_OVERRIDES += ro.recovery.orientation=90
PRODUCT_PROPERTY_OVERRIDES += ro.charge_animation.rotation=90
PRODUCT_PROPERTY_OVERRIDES += ro.system.default.orientation=90
PRODUCT_PROPERTY_OVERRIDES += ro.bootanimation.orientation=90
PRODUCT_PROPERTY_OVERRIDES += ro.setupwizard.rotation_locked=false
```
2、物理屏幕的旋转角度
```mk
MTK_LCM_PHYSICAL_ROTATION = 90
```
经反复验证不同值的搭配角度后，发现`ro.charge_animation.rotation`的值并没有起作用，其他值都起作用了（PHYSICAL设置为90的情况下），所以可以定位就是充电动画环节出现了故障。
## 查找控制关机充电动画的相关代码
这个直接是驱动相关的内容，其实应该由驱动去处理。
1、之前的修改中查找和修改横竖屏相关的内容，看是否有和充电动画相关的改动；  
2、去搜索引擎中搜索“关机充电动画”相关内容，就找到了实现充电动画的相关代码。

找到实现代码后，首先要做的就是确定具体生效的是哪套代码，检测方式很简单，在T0和S0中相关代码加上不同的语法错误，编译时看报错的是哪个，表明生效的就在哪套。  
确定完生效的具体代码后，剩下的就是抓log查看具体执行过程了。
## 日志分析
因为是关机下的充电动画，故需要通过串口才能抓取到该阶段的log。

![](img/Pasted%20image%2020231124200732.png)
该图是部分**串口log**，其中“kpoc_charger”表明该日志是与“kpoc”相关的日志，然后后续是其具体记录，分别对应的如下图：①是输出语句中内容，②是输出语句所在函数，③是输出语句对应所在的行号。
![](img/Pasted%20image%2020231124201247.png)
根据这段日志可以找出对应的文件，然后分析到是没有进入正常的充电动画绘制过程（show_animation_common.c），且结合绘制过程中存在的关于“2供屏不支持旋转”的注释，故将该问题转移给驱动解决。
# 相关资料
[]()